---
toc: true
layout: post
description: 本記事では、キーベアを使用する際の注意点について説明します
categories: [ssh,]
title: SSH鍵の作成と使用について
---

## はじめに 

現在のシステム開発・運用において、Linuxにリモートアクセスする際には、公開鍵認証を用いたSSH(Secure Shell)が多く使用されています。
本記事では、キーベアを使用する際の注意点について説明します。

## SSH・公開鍵認証とは何か(簡単に)

### SSHとは
  - サーバへネットワークを介したリモートログインを安全に行うためのプロトコルです
  - 通信経路が暗号化されるためインターネットを経由しても安全にアクセスできます

### 公開鍵認証とは

  - 秘密鍵と公開鍵のペアを使って認証する方式です
    - 秘密鍵と公開鍵のペアをキーペアと言います
    - 公開鍵をアクセス先のサーバに登録し、秘密鍵をアクセス元のPC等に保管します
    - 十分な鍵長をもったキーペアであれば、使い回すことのリスクがほぼありません
        - 秘密鍵はネットワーク上に一切送出されません
        - 暗号化方式や鍵長にもよりますが、公開鍵から秘密鍵を割り出すことは、(理論上は可能ですが)現実的には非常に困難です
        

## キーペアの作成

- どこで作成するか

    キーペアはローカルPCで作成します。
    macOSであれば`ssh-keygen`コマンドを用いて作成します。
    AWS EC2など、サービス側でキーペアを作成し秘密鍵をダウンロードすることができるサービスものもありますが、サービスごとにキーペアを作成するよりも、ローカルPCで一つのキーペアを作成し、作成した公開鍵をそれぞれのサービスへ登録する方が管理が簡単になります。

- 鍵の種類と鍵長

    SSHで使用するキーペアにはいくつかの種類があり、作成時に選択することができます。

    - Ed25519

        RSAよりも強固でパフォーマンスも良い方式です。
        鍵長は256bit固定です。
        古いSSHクライアントやサーバは対応していない場合があります。

        ssh-keygenコマンドでは`-t`オプションに`ed25519`を与えることで作成できます。

        ```
        ssh-keygen -t ed25519
        ```

    - RSA

        移植性が高いがセキュリティを確保するためには鍵長を大きくする必要があります。
        鍵長は最小1024bit,最大16384bitです。
        一般に3072bitで十分とされています。
        macOS Venturaでは、デフォルトでは使用できなくなっています。

        `ssh-keygen`コマンドで作成する場合はデフォルトでRSA 2048bitのキーペアが作成されます。
        RSAを明示的に指定する場合は`-t`オプションに`rsa`を与えます。鍵長は`-b`オプションで指定できます。

        rsaを明示的に設定して鍵長4096bitのキーペアを作成する場合は以下のようになります。

        ```
        ssh-keygen -t rsa -b 4096
        ```

    - ECDSA

        Ed25519よりも移植性が高いが、安全性には懸念が持たれています。
        Ed25519が使用可能なのであれば、選択する必要はないでしょう。

    - DSA

        脆弱性が発見されたため使用してはいけません。
        新しいOpenSSHサーバでは使用できなくなっています。

    キーペアを新しく作成する際は、使用可能であるならばEd25519を、Ed25519が使用できないならば3072bitまたは4096bitのRSAを選択するのが良いでしょう。

- パスフレーズを設定する
    
    パスフレーズは必ず設定しましょう。
    設定するパスフレーズは、システムにログインする際のパスワードと同じく、十分に長く推測が困難なものを設定すべきです。
    パスフレーズを設定しないと、秘密鍵は平文で保存されることになるので、Linuxサーバに保存した場合はrootユーザがアクセスできてしまいます。

    `ssh-keygen`コマンドでキーペアを作成する場合は、パスフレーズを要求するプロンプトが表示されるので、そこで設定します。

    ```
    $ ssh-keygen -t ed25519
    Generating public/private ed25519 key pair.
    Enter file in which to save the key (/Users/user/.ssh/id_ed25519): yes
    Enter passphrase (empty for no passphrase):    # <= ここでパスフレーズを入力
    Enter same passphrase again:                   # <= パスフレーズを再入力
    ```

## 秘密鍵の使用

### SSH接続する際はssh-agentを使用する

何度もSSH接続する場合、パスフレーズの入力が面倒になります。
`ssh-agent`は秘密鍵を一時的に保存することができ、保存の際にパスフレーズを入力しておけば、使用の際にはパスフレーズを入力せずにSSH接続ができます。
ただし、他人にPCを操作されるとパスフレーズ入力なしでSSH接続されてしまうので、離席時にはPCをロックしたり登録した鍵を全て削除したりといった配慮が必要です。
`ssh-agent`はプロセスを終了すると、一時的に保存した秘密鍵を全て忘れます。よってOSの終了や再起動を行うと、使用する秘密鍵を再度登録しなければなりません。

1. ssh-agentを起動する

    macOSであれば`ssh-add`コマンドの実行をトリガーとして起動するため、起動操作は必要ありません。

1. ssh-agentに秘密鍵を登録する

    `ssh-agent`に秘密鍵を登録するには、`ssh-add`コマンドに秘密鍵のパスを与えます。
    秘密鍵にパスフレーズを設定している場合は入力を要求されるので、入力します。
    登録に成功すると`Identity added: (秘密鍵のパス)`が表示されます。

    ```
    $ ssh-add .ssh/id_ed25519                  # <= 登録する秘密鍵のパス
    Enter passphrase for .ssh/id_ed25519:      # <= 秘密鍵のパスフレーズを入力
    Identity added: .ssh/id_ed25519
    ```

1. ssh-agentに登録されている秘密鍵を確認する

    `ssh-agent`に登録されている秘密鍵を確認するには、`ssh-agent -l`コマンドを実行します

1. ssh-agentから秘密鍵を削除する

    `ssh-agent`に登録されている秘密鍵を削除するには、`ssh-agent -d (秘密鍵のパス)`コマンドを実行します。
    登録されている全ての秘密鍵を削除する場合は`ssh-agent -D`になります。

mac OSであれば、`ssh-add`コマンドに`--apple-use-keychain`オプションを追加することで、秘密鍵をキーチェーンに保管できます。

1. キーチェーンに秘密鍵を登録する

    mac OSのキーチェーンに秘密鍵を登録するには、`ssh-add`コマンドに`--apple-use-keychain`を与えます。
    この操作により、`ssh-aget`に秘密鍵を追加するのと同時にキーチェーンにも秘密鍵を追加します。

    ```
    ssh-add --apple-use-keychain .ssh/id_ed25519  # <= 登録する秘密鍵のパス
    Enter passphrase for .ssh/id_ed25519:         # <= 秘密鍵のパスフレーズを入力
    Identity added: .ssh/id_ed25519
    ```

1. キーチェーンから秘密鍵を読み込む

    `ssh-agent`を終了すると追加した秘密鍵を忘れてしまうのは前述した通りです。
    秘密鍵をキーチェーンに追加してある場合は`ssh-add`コマンドに`--apple-load-keychain`オプションを与えると、キーチェーンから秘密鍵を読み込みます。

    ```
    ssh-add --apple-load-keychain
    Identity added: .ssh/id_ed25519  # <= ロードされた秘密鍵
    ```

## その他

- パスフレーズを設定していないキーペアを既に使用している場合

    `ssh-keygen`コマンドの`-p`オプションを使うと、パスフレーズを再設定できます

    ```
    ssh-keygen -p -f (パスフレーズを再設定する秘密鍵のパス)
    ```


